\documentclass[a4paper,titlepage]{article}

\title{Lucre: Anonymous Electronic Tokens}
\author{Ben Laurie \\
ben@algroup.co.uk}

\begin{document}
\maketitle

\def\mod#1{\,(\textrm{mod}\,#1)}
\def\implies{\Rightarrow}
\def\qe#1{\begin{equation}#1\end{equation}}
\def\oneway#1{\textrm{oneway}(#1)}

\setlength{\parindent}{0pt}
\setlength{\parskip}{1ex plus 0.5ex minus 0.2ex}

\section{Introduction}

This is a revised version of the theory of blinded coins that may not
violate Chaum's patent\footnote{At least, that's what people
think. Take legal advice before using this stuff!}, based on the
original work by David Wagner, and conversations with Ian Goldberg and
Anonymous.

\section{Coins}

\subsection{Creating the Mint}

The mint chooses a prime, $p$, with $(p-1)/2$ also prime, a generator,
$g$, s.t.

\qe{g^2 \neq 1 \mod p}

and

\qe{\label{eq:1}g^{(p-1)/2} = 1 \mod p}

(see \ref{sec:theory1}) and a random number, $k$,

\qe{k \in [\log_g(p)+1,(p-1)/2-\log_g(p)-1]}

The ends are chopped to off to avoid an attack to
find the discrete log by calculating the standard (i.e. non-discrete)
log.

Let $G$ be the group generated by $g$.

The mint publishes

\qe{(g,p,g^k \mod p)}

\subsection{Withdrawing a Coin}

To withdraw a coin Alice picks a random $x$, the coin ID, and
calculates,

\qe{y=\oneway{x}}

(see \ref{sec:oneway}). $y$ should be in $G$; check that

\qe{y^{(p-1)/2}=1 \mod p}

Alice chooses a random blinding factor $b$ and sends $y g^b$ (the coin
request) to the mint. The mint debits Alice's account and returns the
blinded signature,

\qe{m=(y g^b)^k \mod p}

Alice unblinds $m$, calculating the signature,

\qe{z=m (g^k)^{-b}=(y g^b)^k g^{-kb}=y^k g^{bk} g^{-kb}=y^k \mod p}

The coin is then

\qe{c=(x,z)}

\subsection{Spending a Coin}

To spend a coin, Alice simply gives the coin, $c$, to Bob. Bob then
sends it to the mint to be checked. The mint first ensures that $x$
has not already been spent, and that $\oneway x$ is in $G$, then checks that
$z$ is a signature for $x$ (i.e. $z=\oneway{x}^k \mod p$). The mint
then records $x$ as spent and credits Bob's account.

\section{Attack}

Unfortunately an attack on the anonymity of this protocol is
possible. The mint can mark a coin in a way that only it can detect,
by signing it with $k'$ instead of $k$. Then the unblinded
``signature'' is

\qe{z=(y g^b)^{k'} g^{-bk}=y^{k'} g^{b(k'-k)} \mod p}

When Bob submits $c$ to the mint, then the mint calculates

\qe{y (z y^{-k'})^{1/(k'-k)}=y (g^{b(k'-k)})^{1/(k'-k)}=y g^b \mod p}

The mint can then simply look up who sent $y g^b$ to it and thus learn
Alice's identity.

\section{Defence}

The defence against this attack is to make the mint prove that it has
signed with $k$ and not some other number. Since the mint must not
reveal $k$, this proof must be a zero-knowledge proof. Two possible
zero-knowledge proofs are known to me.

\subsection{Variation 1}

This variation was suggested by Ian Goldberg.

Given a coin request, $y g^b$, the mint chooses a random number $r$
 s.t.

\qe{r \in [\log_g(p)+1,(p-1)/2-\log_g(p)-1]}

and calculates

\qe{t=k/r \mod{(p-1)/2}}

($(p-1)/2$ rather than $p$ because we are working in $G$, which has order
$(p-1)/2$). The mint then sends Alice

\qe{Q=(y g^b)^r \mod p}

and

\qe{A=g^r \mod p}

Alice then randomly demands one of $r$ or $t$.

If Alice chose $r$, she verifies that

\qe{Q=(y g^b)^r \mod p}

and

\qe{A=g^r \mod p}

If Alice chose $t$, she verifies that

\qe{A^t=g^{rt}=g^k \mod p}

and

\qe{Q^t=(y g^b)^{rt}=(y g^b)^k=z \mod p}.

\subsection{Variation 2}

This variation is due to Chaum and Pedersen (Crypto '92) (I'm told).

The mint chooses a random value $r$ and sends Alice

\qe{u=g^r \mod p}

and

\qe{v=(y g^b)^r \mod p}

Alice responds with a challenge $c$. The mint answers with

\qe{w=ck+r \mod{(p-1)/2}}

Alice verifies that

\qe{g^w=g^{ck+r}=(g^k)^c u \mod p}

and

\qe{(y g^b)^w=(y g^b)^{ck+r}=((y g^b)^k)^c v=(y g^b)^c v \mod p}

\subsection{Non-interactive variant}

It is suggested that choosing

\qe{c=hash(u,v)}

would allow the second variation to be used non-interactively. The
mint sends $(c,w)$ along with the coin, Alice calculates

\qe{g^w (g^k)^{-c}=u \mod p}

and

\qe{(y g^b)^w S^{-c}=v \mod p}

and verifies that $c=hash(u,v)$.

I'm not entirely convinced that it isn't possible to search for (or
even calculate) a set of values that makes this appear to work whilst
still signing with $k'$.

\section{Theory}

\subsection{Subgroup Order}
\label{sec:theory1}

(\ref{eq:1}) ensures that the order of the subgroup generated by $g$ is
$(p-1)/2$.

\subsubsection{Leakage}

This avoids leakage of information about $k$ which can
occur if $g$ generates the whole of $Z_p^*$, because

\qe{(g^k)^{(p-1)/2}\left\{\begin{array}{ll}
	=1 & \textrm{if $k$ is even} \\
	\neq 1 & \textrm{if $k$ is odd} \\
\end{array} \right.}

{\bf Proof}

If $k$ is even, then there exists an $n$
s.t. $k=2n$.

\qe{(g^{2n})^{(p-1)/2}=(g^n)^{p-1}}

Since

\qe{gcd(g^n,p)=1}

then, by Euler's theorem, 

\qe{\label{eq:2}(g^n)^{p-1}=1 \mod p}

If $k$ is odd, then there exists an $n$ s.t. $k=2n+1$.

\qe{(g^{2n+1})^{(p-1)/2}=(g^n)^{p-1} g^{(p-1)/2}}

\qe{(g^n)^{p-1}=1 \mod p}

(see (\ref{eq:2})) and

\qe{g^{(p-1)/2} \neq 1 \mod p}

because the order of $g$ is $p-1$, so no $y < p-1$ can give $g^y=1
 \mod p$. So

\qe{(g^n)^{p-1} g^{(p-1)/2}=1 \cdot x \mod p, x \neq 1}

\subsubsection{Invertability}

The ZK proofs require exponents to be invertible, and in any case this
may be a useful property. This would not be possible in an exponent
group of order $p-1$ because $x^{-1}
\mod{p-1}$ does not exist if $gcd(x,p-1) \neq 1$, which would be the
case for all even $x$.

\subsection{One-way Coin Function}
\label{sec:oneway}

The purpose of the one way function is to prevent Alice from cheating
the mint by producing variants on a signed coin by simpy reblinding
the coin and the signature - the fact that the coin has a special
structure prevents this from working.

The one-way coin function can, in principle, be any one way function,
but the one chosen for Lucre is defined as follows: Let the random
seed for the coin be in $[0,2^n)$ where 

\qe{n=m+((\log_g(p)-m) \bmod 160)}

$m$ is the minimim number of bits in $x$, chosen to be large
enough to avoid collisions (128 in Lucre's case). Then define

\qe{h_0(x)=x, h_k(x)=h_{k-1}(x)|SHA1(h_{k-1}(x))}

where $|$ denotes concatenation. Then

\qe{\oneway{x}=h_{(n-m)/160}(x)}

In case it isn't obvious, this ensures that

\qe{\log_g(\oneway x) \approx \log_g(p)}



\end{document}
